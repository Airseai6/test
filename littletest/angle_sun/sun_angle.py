#! python3
# -*- coding:utf-8 -*-

from math import *
import time


def cal_hs(phi, delta, t):
    """
    计算太阳高度角，sin_hs=sinφ*sinδ+cosφ*cosδ*cos t
    φ观测地地理纬度；δ太阳赤纬；（太阳赤纬与地理纬度都是北纬为正，南纬为负）；t地方时(时角)，每小时偏离15°
    """
    sin_hs = sin(phi)*sin(delta) + cos(phi)*cos(delta)*cos(t)
    hs = asin(sin_hs)
    return hs


def cal_as(phi, delta, t):
    """
    计算太阳方位角，cos_as=(sin_hs*sinφ-sinδ)/(cos_hs*cosφ)
    as为关键词，用aas
    hs:太阳高度角；φ观测地地理纬度；δ太阳赤纬；t地方时(时角)。
    """
    hs = cal_hs(phi, delta, t)
    cos_as = (sin(hs) * sin(phi) - sin(delta)) / (cos(hs) * cos(phi))
    aas = acos(cos_as)
    return aas


def cal_n(date):
    """
    计算某天是一年中的第多少天
    :param date: 日期字符，例如：'2017-12-31'
    :return: 整型变量
    """
    mon_nums = [31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31]
    year = int(date[:4])
    mon = int(date[5:7])
    day = int(date[8:10])
    if mon > 1:
        sum_data = sum(mon_nums[:mon - 1]) + day
    else:
        sum_data = day
    if year % 4 == 0 and mon > 2:
        sum_data += 1
    return sum_data


def cal_delta(n):
    """
    δ太阳赤纬度计算
    δ=0.006918-0.399912*cos(b)+0.070257*sin(b)-0.006758*cos(2*b)+0.000907*sin(2*b)-0.002697*cos(3*b)+0.00148*sin(3*b)
    其中delta(δ)的单位为弧度；pi=3.1415926为圆周率；b=2*pi*(N-1)/365，单位为弧度；
    :param n: N为日数，自每年1月1日开始计算。
    :return: 角度度数
    """
    b = 2*pi*(n-1)/365
    coe = [0.006918, -0.399912, 0.070257, -0.006758, 0.000907, -0.002697, 0.00148]
    delta = coe[0]+coe[1]*cos(b)+coe[2]*sin(b)+coe[3]*cos(2*b)+coe[4]*sin(2*b)+coe[5]*cos(3*b)+coe[6]*sin(3*b)
    return delta


def lookup_delta_time(date):
    """
    查找每天的太阳时差
    :param data: '1-1'代表一月一日
    :return:返回所差秒数
    """
    delta_time_data = {'01-01': '-189', '01-02': '-218', '01-03': '-246', '01-04': '-273', '01-05': '-301', '01-06': '-327', '01-07': '-354', '01-08': '-380', '01-09': '-405', '01-10': '-430', '01-11': '-455', '01-12': '-479', '01-13': '-502', '01-14': '-525', '01-15': '-547', '01-16': '-568', '01-17': '-589', '01-18': '-609', '01-19': '-628', '01-20': '-647', '01-21': '-665', '01-22': '-682', '01-23': '-698', '01-24': '-714', '01-25': '-728', '01-26': '-742', '01-27': '-755', '01-28': '-779', '01-29': '-790', '01-30': '-799', '01-31': '-817', '02-01': '-824', '02-02': '-830', '02-03': '-836', '02-04': '-841', '02-05': '-845', '02-06': '-849', '02-07': '-851', '02-08': '-853', '02-09': '-854', '02-10': '-855', '02-11': '-854', '02-12': '-853', '02-13': '-851', '02-14': '-848', '02-15': '-845', '02-16': '-841', '02-17': '-836', '02-18': '-831', '02-19': '-824', '02-20': '-818', '02-21': '-810', '02-22': '-802', '02-23': '-793', '02-24': '-664', '02-25': '-774', '02-26': '-763', '02-27': '-752', '02-28': '-741', '02-29': '-728', '03-01': '-716', '03-02': '-703', '03-03': '-689', '03-04': '-675', '03-05': '-661', '03-06': '-647', '03-07': '-632', '03-08': '-616', '03-09': '-601', '03-10': '-585', '03-11': '-568', '03-12': '-552', '03-13': '-535', '03-14': '-518', '03-15': '-501', '03-16': '-484', '03-17': '-466', '03-18': '-449', '03-19': '-431', '03-20': '-413', '03-21': '-395', '03-22': '-377', '03-23': '-358', '03-24': '-340', '03-25': '-322', '03-26': '-304', '03-27': '-285', '03-28': '-267', '03-29': '-249', '03-30': '-231', '03-31': '-213', '04-01': '-196', '04-02': '-178', '04-03': '-161', '04-04': '-144', '04-05': '-127', '04-06': '-110', '04-07': '-93', '04-08': '-77', '04-09': '-61', '04-10': '46', '04-11': '30', '04-12': '16', '04-13': '1', '04-14': '13', '04-15': '27', '04-16': '41', '04-17': '54', '04-18': '66', '04-19': '79', '04-20': '91', '04-21': '102', '04-22': '113', '04-23': '124', '04-24': '134', '04-25': '143', '04-26': '153', '04-27': '161', '04-28': '169', '04-29': '177', '04-30': '184', '05-01': '70', '05-02': '196', '05-03': '201', '05-04': '206', '05-05': '210', '05-06': '217', '05-07': '216', '05-08': '219', '05-09': '220', '05-10': '222', '05-11': '222', '05-12': '222', '05-13': '222', '05-14': '221', '05-15': '219', '05-16': '217', '05-17': '214', '05-18': '211', '05-19': '207', '05-20': '203', '05-21': '198', '05-22': '193', '05-23': '187', '05-24': '181', '05-25': '174', '05-26': '167', '05-27': '159', '05-28': '151', '05-29': '142', '05-30': '133', '05-31': '124', '06-01': '114', '06-02': '104', '06-03': '94', '06-04': '83', '06-05': '72', '06-06': '60', '06-07': '48', '06-08': '36', '06-09': '24', '06-10': '12', '06-11': '1', '06-12': '14', '06-13': '39', '06-14': '52', '06-15': '-65', '06-16': '-78', '06-17': '-91', '06-18': '-105', '06-19': '-117', '06-20': '-130', '06-21': '-143', '06-22': '-156', '06-23': '-168', '06-24': '-181', '06-25': '-193', '06-26': '-205', '06-27': '-217', '06-28': '-229', '06-29': '-240', '06-30': '-251', '07-01': '-262', '07-02': '-273', '07-03': '-283', '07-04': '-293', '07-05': '-302', '07-06': '-311', '07-07': '-320', '07-08': '-328', '07-09': '-336', '07-10': '-343', '07-11': '-350', '07-12': '-356', '07-13': '-362', '07-14': '-368', '07-15': '-372', '07-16': '-376', '07-17': '-380', '07-18': '-383', '07-19': '-385', '07-20': '-387', '07-21': '-389', '07-22': '-389', '07-23': '-389', '07-24': '-389', '07-25': '-388', '07-26': '-386', '07-27': '-384', '07-28': '-381', '07-29': '-377', '07-30': '-373', '07-31': '-368', '08-01': '-363', '08-02': '-357', '08-03': '-351', '08-04': '-344', '08-05': '-336', '08-06': '-328', '08-07': '-319', '08-08': '-310', '08-09': '-300', '08-10': '-290', '08-11': '-279', '08-12': '-267', '08-13': '-255', '08-14': '-242', '08-15': '-229', '08-16': '-216', '08-17': '-201', '08-18': '-187', '08-19': '-171', '08-20': '-156', '08-21': '-140', '08-22': '-123', '08-23': '-107', '08-24': '-89', '08-25': '-72', '08-26': '54', '08-27': '35', '08-28': '17', '08-29': '2', '08-30': '21', '08-31': '41', '09-01': '60', '09-02': '80', '09-03': '100', '09-04': '121', '09-05': '141', '09-06': '162', '09-07': '183', '09-08': '183', '09-09': '204', '09-10': '225', '09-11': '246', '09-12': '267', '09-13': '288', '09-14': '310', '09-15': '331', '09-16': '353', '09-17': '374', '09-18': '395', '09-19': '417', '09-20': '438', '09-21': '459', '09-22': '480', '09-23': '501', '09-24': '522', '09-25': '542', '09-26': '562', '09-27': '582', '09-28': '602', '09-29': '621', '09-30': '640', '10-01': '659', '10-02': '678', '10-03': '696', '10-04': '696', '10-05': '713', '10-06': '731', '10-07': '748', '10-08': '764', '10-09': '780', '10-10': '796', '10-11': '796', '10-12': '811', '10-13': '825', '10-14': '839', '10-15': '853', '10-16': '866', '10-17': '878', '10-18': '890', '10-19': '901', '10-20': '912', '10-21': '681', '10-22': '931', '10-23': '940', '10-24': '948', '10-25': '955', '10-26': '961', '10-27': '967', '10-28': '972', '10-29': '976', '10-30': '980', '10-31': '982', '11-01': '984', '11-02': '985', '11-03': '985', '11-04': '984', '11-05': '983', '11-06': '981', '11-07': '977', '11-08': '973', '11-09': '969', '11-10': '963', '11-11': '956', '11-12': '949', '11-13': '941', '11-14': '932', '11-15': '922', '11-16': '911', '11-17': '900', '11-18': '887', '11-19': '874', '11-20': '860', '11-21': '846', '11-22': '830', '11-23': '814', '11-24': '797', '11-25': '779', '11-26': '760', '11-27': '741', '11-28': '721', '11-29': '700', '11-30': '678', '12-01': '656', '12-02': '633', '12-03': '609', '12-04': '585', '12-05': '561', '12-06': '535', '12-07': '509', '12-08': '483', '12-09': '456', '12-10': '429', '12-11': '402', '12-12': '374', '12-13': '346', '12-14': '317', '12-15': '288', '12-16': '259', '12-17': '230', '12-18': '201', '12-19': '171', '12-20': '142', '12-21': '112', '12-22': '82', '12-23': '52', '12-24': '23', '12-25': '7', '12-26': '37', '12-27': '-66', '12-28': '-96', '12-29': '-125', '12-30': '-154', '12-31': '-183'}
    try:
        sec = int(delta_time_data[date])
    except:
        sec = 0
    return sec


def cal_t(E, now_time, date, flag):
    """
    时角由太阳时(也叫“真太阳时”)计算。
    t = (true_t-12)*15 下面关于时间计算均是以秒为单位
    在中国地区，真太阳时的换算公式为：真太阳时= 北京时间+时差, 时差=（当地经度-120°）/15°
    （当地经度-120°）*4为所差分钟数
    :param E: 经度
    :param date: 输入日期，用于查找每天12:00的太阳时差:delta_time
    :param now_time: 这种格式输入（11:08:49），可以选择系统时间
    :param flag: 如果flag为1就选择系统时间，为0手动输入
    :return:
    """
    delta_time = lookup_delta_time(date)
    # print(date, 'delta_time:', delta_time, 's')
    if flag == 1:
        now_time = time.strftime('%H:%M:%S', time.localtime(time.time()))
    # print('Beijing time:', now_time)
    delta_t = (E-120)*4*60
    now_hou = int(now_time[:2])
    now_min = int(now_time[3:5])
    now_sec = int(now_time[6:])
    true_t = now_hou*3600 + now_min*60 + now_sec + delta_t + delta_time
    # local_hou = int(true_t/3600)
    # local_min = int((true_t%3600)/60)
    # local_sec = int(true_t%60)
    # print('local time: ', local_hou, local_min, local_sec)
    t = (true_t - 12*3600)/3600*15

    return t


def main(E, N, date, bj_time, flag=0):
    """
    算不同地区不同时间的太阳高度角与方位角
    :param E: 目标地东经经度，西经为负
    :param N: 目标地北纬纬度，南纬为负
    :param date:日期（差一天的情况考虑一下） 格式：2019-02-23
    :param bj_time:手动输入想要的时间 格式：23:14:52
    :param flag:如果此值为1，时间为系统时间，手动输入的时间不管用，如果为0，计算手动输入的时间
    :return:
    """
    delta = cal_delta(cal_n(date))
    t = cal_t(E, bj_time, date[6:], flag)
    high_angle = cal_hs(N, delta, t)
    position_angle = cal_as(N, delta, t)
    return [high_angle, position_angle]


if __name__ == '__main__':
    E = 120
    N = 23.5
    date = '2019-02-23'
    bj_time = '08:23:31'
    a, b = main(E, N, date, bj_time)
    print(a, b)
